<html>
  <head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="scripts/construct.js"></script>
    <script src="scripts/single.js"></script>
    <script src="scripts/double.js"></script>
    <style>
      * {
        font-family: Arial;
      }

      .nation {
        fill: #ddd;
      }
      .outline {
        stroke: black;
        stroke-width: 1px;
        fill: none;
      }
      #slider_wrapper {
        height: 80px;
        width: 100vw;
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        background-color: rgb(48, 63, 36);
        align-items: center;
        box-sizing: border-box;
        padding: 0 25px 0 25px;
      }
      #playPauseButton {
        background-color: white;
        border-radius: 25px;
        width: 150px;
        height: 40px;
        outline: none;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
      }
      #playPauseButton:hover {
        background-color: rgb(227, 227, 227);
      }
      #slider_title {
        font-size: 24px;
        font-weight: bold;
        margin: 0 10px 0 25px;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>Education in the United States</h1>
    <h2>For more detail, click on a state</h2>
    <div id="screen_select">
      <button id="switch_mode_single">Single</button>
      <button id="switch_mode_comp">Comparison</button>
      <svg
        id="main"
        height="500"
        width="800"
        style="background: #fff; margin-top: 50px"
      ></svg>
    </div>

    <div style="display: none" id="screen_single">
      <p id="single_title">State:</p>
      <svg id="singleSvg" height="500" width="800"></svg>
      <button id="single_back">Back</button>
    </div>

    <div style="display: none" id="screen_double">
      <p id="double_title">States:</p>
      <svg id="doubleSvg"
      height="600"
      width="800"
      style="background: #fff; margin-top: 50px"
      ></svg>
      <button id="double_back">Back</button>
    </div>

    <div id="slider_wrapper">
      <button id="playPauseButton">Play</button>
      <p id="slider_title">2000</p>
    </div>

    <script>
      let yearIndex = 0;
      let selected = null;
      let compSelected = [];
      let isSingle = true;
      let play = false;
      let interval;

      // SETUP SVGS
      const mainSvg = d3.select('#main');
      const mainWidth = mainSvg.attr('width');
      const mainHeight = mainSvg.attr('height');
      const mainMap = mainSvg.append('g');

      const playPauseButton = d3.select('#playPauseButton');
      const switchToSingle = d3.select('#switch_mode_single');
      const switchToComp = d3.select('#switch_mode_comp');
      const singleBack = d3.select('#single_back');
      const compBack = d3.select('#double_back');

      async function main() {
        const [us, data] = await Promise.all([
          d3.json('/data/states-10m.json'),
          d3.csv('/data/final.csv'),
        ]);

        const stateDict = new StateDict(data);
        const allScores = stateDict.getScores();
        const years = stateDict.getYears();
        const colorScale = d3
          .scaleQuantile()
          .domain(allScores)
          .range(['#94003a', '#a3593b', '#ad9138', '#afc72c', '#a8fe00']);

        const projection = d3.geoAlbersUsa().scale(800);
        // .translate([487.5, 305]);
        const path = d3.geoPath().projection(projection);

        const nation = topojson.feature(us, us.objects.nation);
        const states = topojson.feature(us, us.objects.states);
        const statesMesh = topojson.mesh(us, us.objects.states);

        mainMap
          .selectAll('path.nation')
          .data(nation.features)
          .join('path')
          .attr('class', 'nation')
          .attr('d', path);

        mainMap
          .append('path')
          .datum(statesMesh)
          .attr('class', 'outline')
          .attr('d', path);

        function renderStates(year, isSingle) {
          mainMap
            .selectAll('path.states')
            .data(states.features)
            .join('path')
            .attr('stateName', name)
            .attr('class', 'state')
            .attr('fill', (d) => score(d, year))
            .attr('d', path)
            .on('click', isSingle ? selectState : selectComp);
        }

        function reset() {
          selected = null;
          compSelected = [];
          d3.select('#screen_select').style('display', 'block');
          d3.select('#screen_single').style('display', 'none');
          d3.select('#screen_double').style('display', 'none');
          d3.select('#single_title').text('');
        }

        function selectState(e) {
          selected = e.target.getAttribute('stateName');
          d3.select('#screen_select').style('display', 'none');
          d3.select('#screen_single').style('display', 'block');
          d3.select('#single_title').text(selected);
          const activeYear = years[yearIndex];
          renderSingle(stateDict, selected, years, activeYear);
        }

        function selectComp(e) {
          // Impossible: 2+ elements in compSelected
          if (compSelected.length > 2) {
            console.warn('compSelected length > 2');
            return;
          }
          selected = e.target.getAttribute('stateName');

          if (compSelected.length === 1) {
            // 1 element in compSelected
            compSelected.push(selected);
            d3.select('#screen_select').style('display', 'none');
            d3.select('#screen_double').style('display', 'block');
            d3.select('#double_title').text(
              'Selected: ' + compSelected.join(', ')
            );
            const activeYear = years[yearIndex];
            renderDouble(stateDict, compSelected, years, activeYear);
          } else {
            compSelected.push(selected);
          }
          return;
        }

        function name(d) {
          const state = stateDict.states[d.properties.name];
          if (!state) return 'unspecified';
          return state.name;
        }

        function score(d, year) {
          const state = stateDict.states[d.properties.name];
          if (!state) return 'grey';
          const record = state.years[year.toString()];
          if (!record) {
            console.warn('NOT FOUND', d.properties.name, year);
            return 'grey';
          }
          return colorScale(record.AVG_SCORE);
        }

        function advanceYear(all_years) {
          yearIndex++;
          if (yearIndex === all_years.length) yearIndex = 0;
          const new_year = all_years[yearIndex];
          d3.select('#slider_title').text(new_year);
          if (selected === null && compSelected.length === 0) {
            renderStates(new_year, isSingle);
          } else if (isSingle) {
            renderSingle(stateDict, selected, years, new_year);
          } else {
            renderDouble(stateDict, compSelected, years, new_year);
          }
        }

        function playOrPause(all_years) {
          if (play) {
            d3.select('#playPauseButton').text('Play');
            play = false;
            clearInterval(interval);
          } else {
            d3.select('#playPauseButton').text('Pause');
            play = true;
            interval = setInterval(() => advanceYear(all_years), 1500);
          }
        }

        function singleView(all_years) {
          reset();
          isSingle = true;
          const year = all_years[yearIndex];
          renderStates(year, isSingle);
        }

        function compView(all_years) {
          reset();
          isSingle = false;
          const year = all_years[yearIndex];
          renderStates(year, isSingle);
        }

        playPauseButton.on('click', () => playOrPause(years));
        switchToSingle.on('click', () => singleView(years));
        switchToComp.on('click', () => compView(years));
        singleBack.on('click', reset);
        compBack.on('click', reset);
        renderStates(2000, isSingle);

        return;
      }

      main();
    </script>
  </body>
</html>
