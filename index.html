<html>
  <head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="scripts/numberFormatting.js"></script>
    <script src="scripts/construct.js"></script>
    <script src="scripts/single.js"></script>
    <script src="scripts/double.js"></script>
    <script src="scripts/from_class.js"></script>

    <style>
      :root {
        --main-theme: #2a87b7;
        --main-bg: rgb(58, 58, 58);
      }

      body {
        margin: 0;
      }
      * {
        font-family: Arial;
      }
      .state {
        stroke: black;
        cursor: pointer;
      }
      .nation {
        fill: #ddd;
      }
      .outline {
        stroke: black;
        stroke-width: 3px;
        fill: none;
      }
      #header {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        background: var(--main-bg);
        color: white;
        box-sizing: border-box;
        padding: 10px 0 30px 0;
      }
      #header_button_wrapper {
        display: flex;
        justify-content: center;
      }
      #slider_wrapper {
        height: 80px;
        width: 100vw;
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        background-color: var(--main-bg);
        align-items: center;
        box-sizing: border-box;
        padding: 0 25px 0 25px;
      }
      #playPauseButton {
        background-color: white;
        border-radius: 25px;
        width: 150px;
        height: 40px;
        outline: none;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
      }
      #playPauseButton:hover {
        background-color: rgb(227, 227, 227);
      }
      #slider_title {
        font-size: 24px;
        font-weight: bold;
        margin: 0 10px 0 25px;
        color: white;
      }
      .mode_selector {
        margin: 0 10px 0 10px;
        font-size: 24px;
        background-color: darkgrey;
        border-radius: 25px;
        width: 200px;
        height: 40px;
        outline: none;
        border: 1px solid black;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
      }
      .mode_selector:hover {
        box-shadow: black 2px 5px 10px;
      }
      .mode_selector.on {
        background-color: var(--main-theme);
        color: white;
      }
      #map_wrapper {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #legend_wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        margin-top: 40px;
      }
      #screen_select {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      #action_item {
        font-size: 18px;
        font-weight: bold;
      }
      #state_label {
        color: white;
        background-color: var(--main-theme);
        box-sizing: border-box;
        padding: 20px 20px 20px 20px;
        border-radius: 25px;
        margin: 0 50px 0 0;
        display: flex;
        flex-direction: column;
        min-width: 320px;
        box-shadow: grey 5px 5px 10px;
      }
      .line_item {
        width: 100%;
        margin: 2px 0 2px 0;
        display: flex;
        justify-content: space-between;
      }
    </style>
  </head>
  <body>
    <div id="screen_select">
      <div id="map_wrapper">
        <div id="map_column" style="display: flex; flex-grow: 1">
          <svg id="main" style="background: #fff"></svg>
        </div>
        <div id="state_label" style="visibility: hidden">
          <p
            style="
              text-align: center;
              font-weight: bold;
              margin: 0 0 10px 0;
              font-size: 24px;
            "
            id="state_label_name"
          >
            State
          </p>
          <div class="line_item">
            <span>Expenditures per Student: </span>
            <span id="state_label_expenditures"> $0.00 </span>
          </div>
          <div class="line_item">
            <span>GDP per Capita: </span>
            <span id="state_label_gdp">$0.00</span>
          </div>
          <div class="line_item">
            <span>Average NAEP Test Score:</span>
            <span id="state_label_scores">0.00%</span>
          </div>
        </div>
      </div>
      <div id="legend_wrapper">
        <p
          style="
            margin: 0 0 10px 0;
            font-style: italic;
            font-weight: bold;
            font-size: 14px;
          "
        >
          Expenditures per student in thousands of USD (2015)
        </p>
        <svg id="map_legend" height="50" width="500"></svg>
      </div>
      <div id="header">
        <p id="action_item">See more details by clicking on a state.</p>
        <div id="header_button_wrapper">
          <button id="switch_mode_single" class="mode_selector on">
            Single
          </button>
          <button id="switch_mode_comp" class="mode_selector">
            Comparison
          </button>
        </div>
      </div>
    </div>

    <div
      style="
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      "
      id="screen_single"
    >
      <p id="single_title">State:</p>
      <svg id="singleSvg" height="600" width="800"></svg>
      <button id="single_back">Back</button>
    </div>

    <div style="display: none" id="screen_double">
      <p id="double_title">States:</p>
      <svg
        id="doubleSvg"
        height="600"
        width="800"
        style="background: #fff; margin-top: 50px"
      ></svg>
      <button id="double_back">Back</button>
    </div>

    <div style="display: none" id="slider_wrapper">
      <button id="playPauseButton">Play</button>
      <p id="slider_title">2003</p>
    </div>

    <script>
      let yearIndex = 0;
      let selected = null;
      let compSelected = [];
      let isSingle = true;
      let play = false;
      let interval;
      const animationDuration = 25;
      const hoverOpacity = 0.5;
      const selectScreenYear = 2015;

      // SETUP SVGS
      const mainSvg = d3.select('#main');
      // const aspectRatio = 2;
      // const mainHeight = parseInt(d3.select('#map_wrapper').style('height'));
      // const mainWidth = mainHeight * aspectRatio;
      const aspectRatio = 0.5;
      const mainWidth = parseInt(d3.select('#map_column').style('width'));
      const mainHeight = mainWidth * aspectRatio;
      mainSvg.style('width', mainWidth);
      mainSvg.style('height', mainHeight);
      const mainMap = mainSvg.append('g');
      const stateLabel = d3.select('#state_label');
      const mapLegend = d3.select('#map_legend');

      const playPauseButton = d3.select('#playPauseButton');
      const switchToSingle = d3.select('#switch_mode_single');
      const switchToComp = d3.select('#switch_mode_comp');
      const singleBack = d3.select('#single_back');
      const compBack = d3.select('#double_back');
      const modeSwitchLabel = d3.select('#action_item');

      async function main() {
        const [us, data] = await Promise.all([
          d3.json('data/states-10m.json'),
          d3.csv('data/final.csv'),
        ]);

        const stateDict = new StateDict(data);
        const domain = stateDict.getAllForField(
          2015,
          'EXPENDITURE_PER_STUDENT'
        );
        const years = stateDict.getYears();
        const colorScale = d3
          .scaleQuantile()
          .domain(domain)
          .range(['#202c49', '#274c6f', '#2979a3', '#16b6eb']);

        const projection = d3
          .geoAlbersUsa()
          .scale(mainWidth)
          .translate([mainWidth / 2, mainHeight / 2]);
        const path = d3.geoPath().projection(projection);

        const nation = topojson.feature(us, us.objects.nation);
        const states = topojson.feature(us, us.objects.states);
        const statesMesh = topojson.mesh(us, us.objects.states);

        mainMap
          .selectAll('path.nation')
          .data(nation.features)
          .join('path')
          .attr('class', 'nation')
          .attr('d', path);

        mainMap
          .append('path')
          .datum(statesMesh)
          .attr('class', 'outline')
          .attr('d', path);

        function renderStates(year, isSingle) {
          mainMap
            .selectAll('path.state')
            .data(states.features)
            .join('path')
            .attr('stateName', name)
            .attr('class', 'state')
            .attr('fill', (d) => score(d, year))
            .attr('d', path)
            .style('opacity', 1)
            .on('mouseover', onMouseOver(!isSingle))
            .on('mouseleave', onMouseLeave(!isSingle))
            .on('click', isSingle ? selectState : selectComp);
        }

        function reset() {
          selected = null;
          compSelected = [];
          d3.select('path.state').style('opacity', 1);
          d3.select('#screen_select').style('display', 'flex');
          d3.select('#screen_single').style('display', 'none');
          d3.select('#screen_double').style('display', 'none');
          d3.select('#slider_wrapper').style('display', 'none');
          d3.select('#single_title').text('');
        }

        function selectState(e) {
          selected = e.target.getAttribute('stateName');
          d3.select('#screen_select').style('display', 'none');
          d3.select('#slider_wrapper').style('display', 'flex');
          d3.select('#screen_single').style('display', 'flex');
          d3.select('#single_title').text(selected);
          const activeYear = years[yearIndex];
          renderSingle(stateDict, selected, years, activeYear);
        }

        function selectComp(e) {
          // Impossible: 2+ elements in compSelected
          if (compSelected.length > 2) {
            console.warn('compSelected length > 2');
            return;
          }
          const ele = d3.select(this);
          selected = e.target.getAttribute('stateName');

          if (compSelected.length === 1) {
            // 1 element in compSelected
            if (selected === compSelected[0]) {
              // Deselect and return.
              compSelected = [];
              ele.style('opacity', hoverOpacity);
              return;
            }
            compSelected.push(selected);
            d3.select('#screen_select').style('display', 'none');
            d3.select('#slider_wrapper').style('display', 'flex');
            d3.select('#screen_double').style('display', 'block');
            d3.select('#double_title').text(
              'Selected: ' + compSelected.join(', ')
            );
            const activeYear = years[yearIndex];
            renderDouble(stateDict, compSelected, years, activeYear);
          } else {
            compSelected.push(selected);
            ele.style('opacity', 1);
          }
          return;
        }

        function name(d) {
          const state = stateDict.states[d.properties.name];
          if (!state) return 'unspecified';
          return state.name;
        }

        function score(d, year) {
          const state = stateDict.states[d.properties.name];
          if (!state) return 'grey';
          const record = state.years[year.toString()];
          if (!record) {
            console.warn('NOT FOUND', d.properties.name, year);
            return 'grey';
          }
          return colorScale(record.EXPENDITURE_PER_STUDENT);
        }

        function advanceYear(all_years) {
          yearIndex++;
          if (yearIndex === all_years.length) yearIndex = 0;
          const new_year = all_years[yearIndex];
          d3.select('#slider_title').text(new_year);
          if (selected === null && compSelected.length === 0) {
            renderStates(2015, isSingle);
          } else if (isSingle) {
            renderSingle(stateDict, selected, years, new_year);
          } else {
            renderDouble(stateDict, compSelected, years, new_year);
          }
        }

        function playOrPause(all_years) {
          if (play) {
            d3.select('#playPauseButton').text('Play');
            play = false;
            clearInterval(interval);
          } else {
            d3.select('#playPauseButton').text('Pause');
            play = true;
            interval = setInterval(() => advanceYear(all_years), 1500);
          }
        }

        function singleView(all_years) {
          reset();
          isSingle = true;
          renderStates(2015, isSingle);
          switchToSingle.attr('class', 'mode_selector on');
          switchToComp.attr('class', 'mode_selector');
          modeSwitchLabel.text('See more details by clicking on a state.');
        }

        function compView(all_years) {
          reset();
          isSingle = false;
          renderStates(2015, isSingle);
          switchToComp.attr('class', 'mode_selector on');
          switchToSingle.attr('class', 'mode_selector');
          modeSwitchLabel.text('Select two states to compare them.');
        }

        function onMouseOver(isComp) {
          return function (e) {
            const toChange = isComp
              ? d3.selectAll('path.state').filter((d, i) => {
                  const name = d.properties.name;
                  return !compSelected.includes(name);
                })
              : d3.selectAll('path.state');
            toChange
              .transition()
              .duration(animationDuration)
              .style('opacity', hoverOpacity);
            d3.select(this)
              .transition()
              .duration(animationDuration)
              .style('opacity', 1);
            const stateName = e.target.getAttribute('stateName');
            const record = stateDict.getRecord(stateName, selectScreenYear);
            d3.select('#state_label_name').text(`${stateName}`);
            d3.select('#state_label_expenditures').text(
              `${floatToDollars(record.EXPENDITURE_PER_STUDENT * 1000)}`
            );
            d3.select('#state_label_gdp').text(`
                ${floatToDollars(record.GDP_PER_CAPITA * 1000000)}
            `);
            d3.select('#state_label_scores').text(`
               ${decimalToPercent(record.AVG_SCORE_PERCENTAGE)}
            `);
            stateLabel.style('visibility', 'visible');
          };
        }

        function onMouseLeave(isComp) {
          return function (e) {
            stateLabel.style('visibility', 'hidden');
            if (!isComp) {
              d3.selectAll('path.state')
                .transition()
                .duration(animationDuration)
                .style('opacity', 1);
            } else if (compSelected.length == 1) {
              d3.selectAll('path.state')
                .filter((d, i) => {
                  const name = d.properties.name;
                  return !compSelected.includes(name);
                })
                .transition()
                .duration(animationDuration)
                .style('opacity', hoverOpacity);
            } else {
              d3.selectAll('path.state')
                .transition()
                .duration(animationDuration)
                .style('opacity', 1);
            }
          };
        }

        playPauseButton.on('click', () => playOrPause(years));
        switchToSingle.on('click', () => singleView(years));
        switchToComp.on('click', () => compView(years));
        singleBack.on('click', reset);
        compBack.on('click', reset);
        renderStates(2015, isSingle);
        drawLegend(mapLegend, colorScale);

        return;
      }

      main();
    </script>
  </body>
</html>
